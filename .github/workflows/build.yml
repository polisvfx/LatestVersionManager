name: Build Distributables

# Triggers:
#   - Every push to main/dev (build check, artifacts kept 7 days)
#   - Every pull request to main
#   - When you publish a GitHub Release (artifacts attached to the release)
#   - Manual trigger from the Actions tab
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write   # Required to upload files to GitHub Releases

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false   # Don't cancel other platform builds if one fails
      matrix:
        include:
          - os: windows-latest
            artifact_name: LatestVersionManager-windows
            asset_suffix: windows.zip

          - os: macos-latest
            artifact_name: LatestVersionManager-macos
            asset_suffix: macos.zip

          - os: ubuntu-latest
            artifact_name: LatestVersionManager-linux
            asset_suffix: linux.zip

    steps:
      # ── Checkout ────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Python setup ────────────────────────────────────────────────────────
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # ── Linux: install Qt platform dependencies ──────────────────────────
      # PySide6 on headless Linux needs these system libraries
      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libgl1 \
            libglib2.0-0 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libdbus-1-3 \
            libegl1 \
            libfontconfig1 \
            libfreetype6

      # ── Install Python dependencies ──────────────────────────────────────
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # ── Inject release version into package ─────────────────────────────
      # When triggered by a published release (tag e.g. v1.2.3), patch
      # __init__.py so PyInstaller and the running app both report that version.
      - name: Inject release version
        if: github.event_name == 'release'
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"   # strip leading 'v' (v1.2.3 → 1.2.3)
          perl -i -pe "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" src/lvm/__init__.py
          echo "Version set to: $VERSION"

      # ── Build with PyInstaller ───────────────────────────────────────────
      - name: Build with PyInstaller
        run: pyinstaller lvm.spec

      # ── Linux: Build AppImage (optional, more portable than raw folder) ──
      # Commented out by default — uncomment to also produce an AppImage
      # - name: Build AppImage
      #   if: runner.os == 'Linux'
      #   run: |
      #     wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
      #     chmod +x appimagetool-x86_64.AppImage
      #     # (Requires setting up AppDir structure first)

      # ── macOS: create DMG (optional, nicer than zip for macOS) ──────────
      # Commented out by default — uncomment to produce a .dmg installer
      # - name: Create DMG
      #   if: runner.os == 'macOS'
      #   run: |
      #     brew install create-dmg
      #     create-dmg \
      #       --volname "Latest Version Manager" \
      #       --window-pos 200 120 \
      #       --window-size 600 400 \
      #       --icon-size 100 \
      #       --icon "LatestVersionManager.app" 175 190 \
      #       --hide-extension "LatestVersionManager.app" \
      #       --app-drop-link 425 190 \
      #       "LatestVersionManager.dmg" \
      #       "dist/LatestVersionManager.app"

      # ── Package output ───────────────────────────────────────────────────
      - name: Package output (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path dist\LatestVersionManager\* `
            -DestinationPath dist\${{ matrix.artifact_name }}.zip

      - name: Package output (macOS / Linux)
        if: runner.os != 'Windows'
        run: |
          cd dist
          zip -r ${{ matrix.artifact_name }}.zip LatestVersionManager/

      # ── Upload artifact (for every build — kept 7 days) ─────────────────
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.artifact_name }}.zip
          retention-days: 7

  # ── Attach all artifacts to GitHub Release (only when a release is published) ──
  # Runs after all matrix builds finish, so only one job touches the release.
  publish:
    name: Publish to GitHub Release
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: Upload all artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: dist/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
